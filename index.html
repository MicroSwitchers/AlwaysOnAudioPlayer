<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Online Radio & Media Player</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            -webkit-tap-highlight-color: transparent;
            background-color: #111827; /* Deep dark background */
        }
        .station-item:hover {
            background-color: #374151; /* Softer hover for dark mode */
        }
        .genre-btn, .action-btn {
            transition: all 0.2s ease-in-out;
        }
        .genre-btn:hover, .action-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 20px rgba(0,0,0,0.25);
        }
        .action-btn:active {
            transform: translateY(0);
            box-shadow: none;
        }
        
        /* Hide the default audio player */
        audio {
            display: none;
        }

        /* Glassmorphism Player Background */
        #fullscreen-player {
            background-color: rgba(20, 20, 30, 0.5);
            backdrop-filter: blur(40px) saturate(180%);
            -webkit-backdrop-filter: blur(40px) saturate(180%);
            transition: opacity 0.5s ease-in-out;
        }
        
        /* Animated Aurora Background */
        #fullscreen-player::before {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background: linear-gradient(125deg, #2563eb, #7c3aed, #db2777);
            background-size: 400% 400%;
            animation: gradientBG 20s ease infinite;
            z-index: -1;
            opacity: 0.6;
        }

        @keyframes gradientBG {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        /* Custom Volume Slider */
        input[type=range] { -webkit-appearance: none; width: 100%; background: transparent; }
        input[type=range]:focus { outline: none; }
        input[type=range]::-webkit-slider-runnable-track { width: 100%; height: 4px; cursor: pointer; background: rgba(255, 255, 255, 0.3); border-radius: 5px; }
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; height: 16px; width: 16px; border-radius: 50%; background: #ffffff; cursor: pointer; margin-top: -6px; }

        /* Responsive play button sizes */
        @media (min-width: 640px) {
            .w-18 { width: 4.5rem; }
            .h-18 { height: 4.5rem; }
        }

        /* Styling for the new tabs */
        .tab-btn.active {
            color: #6366f1;
            border-bottom-color: #6366f1;
        }

        /* Small screen optimizations */
        @media (max-width: 480px) {
            #fullscreen-player {
                padding: 0;
            }
            
            #fullscreen-playing-name {
                font-size: 1.5rem;
                line-height: 1.3;
            }
            
            #fullscreen-playing-artist {
                font-size: 1rem;
            }
            
            #fullscreen-playing-tags {
                font-size: 0.875rem;
            }
        }
    </style>
</head>
<body class="text-slate-300">

    <div id="main-content" class="container mx-auto p-4 max-w-5xl">
        <header class="text-center mb-10">
            <h1 class="text-4xl sm:text-5xl font-bold text-slate-100">Media Player</h1>
            <p class="text-lg text-slate-400 mt-2">Listen to online radio or your local files</p>
        </header>

        <main class="space-y-8">
            <!-- Controls Card -->
            <div class="bg-slate-800/50 backdrop-blur-sm p-5 sm:p-6 rounded-xl shadow-2xl border border-slate-700">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-2xl font-semibold text-slate-100">Media Source</h2>
                    <div class="flex flex-col sm:flex-row gap-2">
                        <button id="load-files-btn" class="bg-indigo-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-indigo-700 text-sm flex items-center gap-2">
                            <i class="fas fa-file-audio"></i>Add Files
                        </button>
                        <button id="load-folder-btn" class="bg-purple-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-purple-700 text-sm flex items-center gap-2">
                            <i class="fas fa-folder-open"></i>Add Folder
                        </button>
                        <button id="clear-playlist-btn" class="bg-red-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-red-700 text-sm hidden flex items-center gap-2">
                            <i class="fas fa-trash"></i>Clear
                        </button>
                        <button id="visualizer-btn" class="bg-gradient-to-r from-purple-600 to-pink-600 text-white px-4 py-2 rounded-lg font-semibold hover:from-purple-700 hover:to-pink-700 text-sm flex items-center gap-2">
                            <i class="fas fa-wave-square"></i>Visualizer
                        </button>
                        <button id="toggleSearchBtn" class="bg-slate-700 text-slate-300 px-4 py-2 rounded-lg font-semibold hover:bg-slate-600 text-sm flex items-center gap-2">
                            <i class="fas fa-search"></i>Radio Search
                        </button>
                    </div>
                </div>
                <div id="genre-buttons" class="flex flex-wrap gap-3">
                    <!-- Genre buttons will be injected here -->
                </div>
            </div>
            <input type="file" id="file-input" multiple accept=".mp3,.flac,.wav,.ogg,.m4a,.aac" class="hidden">
            <input type="file" id="folder-input" webkitdirectory multiple accept=".mp3,.flac,.wav,.ogg,.m4a,.aac" class="hidden">


            <!-- Search Section (hidden by default) -->
            <div id="search-section" class="hidden search-section bg-slate-800/50 backdrop-blur-sm p-6 rounded-xl shadow-2xl border border-slate-700">
                <h2 class="text-2xl font-semibold mb-4 text-slate-100">Search for a Station</h2>
                <div class="flex flex-col sm:flex-row gap-4">
                    <input type="text" id="searchInput" class="flex-grow p-3 bg-slate-700 border border-slate-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 text-white" placeholder="Enter station name, genre, or country...">
                    <button id="searchButton" class="bg-indigo-600 text-white px-6 py-3 rounded-lg font-semibold hover:bg-indigo-700">Search</button>
                </div>
            </div>

            <!-- Station Lists Card with Tabs -->
            <div class="bg-slate-800/50 backdrop-blur-sm rounded-xl shadow-2xl border border-slate-700">
                <!-- Tab Navigation -->
                <div class="border-b border-slate-700">
                    <nav class="flex -mb-px" aria-label="Tabs">
                        <button id="tab-results" class="tab-btn active w-1/2 py-4 px-1 text-center border-b-2 font-medium text-lg text-slate-400 hover:text-indigo-400 hover:border-indigo-400">
                          Playlist
                        </button>
                        <button id="tab-favorites" class="tab-btn w-1/2 py-4 px-1 text-center border-b-2 font-medium text-lg text-slate-400 hover:text-indigo-400 hover:border-indigo-400">
                          <i class="fas fa-heart mr-2"></i>Favorites
                        </button>
                    </nav>
                </div>
                
                <!-- Tab Content -->
                <div class="p-2 sm:p-4">
                    <div id="station-list-panel">
                        <div id="station-list" class="space-y-1 max-h-[50vh] overflow-y-auto">
                            <div class="px-4 py-12 text-center text-slate-400">
                                <div class="mb-4">
                                    <i class="fas fa-music text-4xl text-slate-600 mb-4"></i>
                                </div>
                                <p class="text-lg mb-2">No audio files loaded</p>
                                <p class="text-sm text-slate-500 mb-4">Select a genre for radio stations, or add your music:</p>
                                <div class="space-y-2 text-sm">
                                    <p><i class="fas fa-file-audio text-indigo-400 mr-2"></i>Click "Add Files" to select individual tracks</p>
                                    <p><i class="fas fa-folder-open text-purple-400 mr-2"></i>Click "Add Folder" to load an entire album/folder</p>
                                    <p><i class="fas fa-hand-pointer text-blue-400 mr-2"></i>Or simply drag and drop files here</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div id="favorites-panel" class="hidden">
                         <div id="favorites" class="space-y-1 max-h-[50vh] overflow-y-auto">
                            <p class="px-4 py-8 text-center text-slate-400">No favorite stations saved.</p>
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <footer class="text-center mt-12 text-slate-500 text-sm">
            <p>Powered by the <a href="https://www.radio-browser.info/" target="_blank" class="text-indigo-400 hover:underline">Radio Browser API</a></p>
        </footer>
    </div>

    <!-- Visualizer Canvas -->
    <canvas id="visualizer-canvas" class="hidden fixed inset-0 w-full h-full z-10"></canvas>

    <!-- Full Screen Player -->
    <div id="fullscreen-player" class="hidden fixed inset-0 text-white flex flex-col z-50">
        <!-- Top Controls Bar -->
        <div class="flex justify-between items-center p-4 sm:p-6 lg:p-8">
            <div class="flex-1"></div>
            <button id="minimize-btn" class="action-btn bg-white/20 text-white w-12 h-12 sm:w-14 sm:h-14 rounded-full font-semibold hover:bg-white/30 active:bg-white/40 flex items-center justify-center transition-all duration-200 shrink-0">
                <i class="fas fa-chevron-down text-lg sm:text-xl"></i>
            </button>
        </div>

        <!-- Main Content Area -->
        <div class="flex-1 flex flex-col items-center justify-center px-4 sm:px-6 lg:px-8 pb-4">
            <!-- Album Art / Station Icon -->
            <div id="fullscreen-station-icon-container" class="w-32 h-32 sm:w-40 sm:h-40 lg:w-48 lg:h-48 xl:w-56 xl:h-56 rounded-2xl mb-6 sm:mb-8 shadow-2xl bg-slate-700 flex items-center justify-center shrink-0">
                <img id="fullscreen-station-icon" src="" class="w-full h-full rounded-2xl object-cover">
            </div>
            
            <!-- Track Info -->
            <div class="text-center mb-6 sm:mb-8 max-w-full px-4">
                <h1 id="fullscreen-playing-name" class="text-2xl sm:text-3xl lg:text-4xl xl:text-5xl font-bold mb-2 sm:mb-3 leading-tight truncate max-w-full"></h1>
                <p id="fullscreen-playing-artist" class="text-lg sm:text-xl lg:text-2xl text-slate-300 opacity-90 mb-2 truncate"></p>
                <p id="fullscreen-playing-tags" class="text-base sm:text-lg lg:text-xl text-slate-300 opacity-80 truncate"></p>
            </div>
            
            <!-- Progress bar for local files -->
            <div id="progress-container" class="hidden w-full max-w-lg mb-6 sm:mb-8 px-4">
                <div class="flex justify-between text-sm text-slate-400 mb-2">
                    <span id="current-time">0:00</span>
                    <span id="total-time">0:00</span>
                </div>
                <div class="w-full bg-slate-700 rounded-full h-2 sm:h-3 cursor-pointer" id="progress-bg">
                    <div class="bg-indigo-500 h-2 sm:h-3 rounded-full transition-all duration-200" id="progress-bar"></div>
                </div>
            </div>
        </div>

        <!-- Bottom Controls -->
        <div class="p-4 sm:p-6 lg:p-8">
            <div class="w-full max-w-md mx-auto">
                <!-- Volume Controls -->
                <div class="flex items-center gap-3 sm:gap-4 mb-6 sm:mb-8">
                    <i class="fas fa-volume-off text-white/50 text-sm sm:text-base shrink-0"></i>
                    <input id="volume-slider" type="range" min="0" max="1" step="0.01" value="1" class="flex-1">
                    <i class="fas fa-volume-up text-white/80 text-sm sm:text-base shrink-0"></i>
                </div>
                
                <!-- Playback Controls -->
                <div class="flex items-center justify-center gap-4 sm:gap-6 lg:gap-8">
                    <button id="prev-btn" class="action-btn bg-white/10 text-white w-12 h-12 sm:w-14 sm:h-14 lg:w-16 lg:h-16 rounded-full font-semibold text-lg sm:text-xl flex items-center justify-center transition-all duration-200">
                        <i class="fas fa-backward-step"></i>
                    </button>
                    <button id="play-pause-btn" class="action-btn bg-white text-slate-900 w-16 h-16 sm:w-18 sm:h-18 lg:w-20 lg:h-20 rounded-full font-semibold text-2xl sm:text-3xl flex items-center justify-center transition-all duration-200 shadow-lg">
                        <i id="play-pause-icon" class="fas fa-pause"></i>
                    </button>
                    <button id="next-btn" class="action-btn bg-white/10 text-white w-12 h-12 sm:w-14 sm:h-14 lg:w-16 lg:h-16 rounded-full font-semibold text-lg sm:text-xl flex items-center justify-center transition-all duration-200">
                        <i class="fas fa-forward-step"></i>
                    </button>
                </div>
            </div>
        </div>
        
        <audio id="audioPlayer"></audio>
    </div>

    <!-- Minimized Player Bar -->
    <div id="minimized-player" class="hidden fixed bottom-0 left-0 right-0 bg-slate-900/90 backdrop-blur-sm text-white p-3 sm:p-4 shadow-lg z-40 flex justify-between items-center cursor-pointer">
        <div class="flex items-center gap-3 flex-grow truncate min-w-0">
            <div id="minimized-station-icon-container" class="w-10 h-10 sm:w-12 sm:h-12 rounded-md flex-shrink-0 bg-slate-700 flex items-center justify-center">
                 <img id="minimized-station-icon" src="" class="w-full h-full rounded-md object-cover">
            </div>
            <div class="truncate min-w-0 flex-grow">
                <p class="font-bold text-sm sm:text-base truncate" id="minimized-playing-name"></p>
            </div>
        </div>
        <button id="stop-btn-minimized" class="action-btn bg-red-600 text-white w-10 h-10 sm:w-12 sm:h-12 rounded-full font-semibold hover:bg-red-700 flex-shrink-0 flex items-center justify-center ml-3">
            <i class="fas fa-stop text-sm sm:text-base"></i>
        </button>
    </div>


    <script type="module">

        // --- App State & Constants ---
        const RADIO_API_BASE = 'https://de1.api.radio-browser.info/json';
        const GENRES = ['Classical', 'Jazz', 'Blues', 'Opera', 'Piano', 'Baroque', 'Classical Guitar', 'Light Jazz', 'Chamber Music'];
        const PLACEHOLDER_COLORS = ['#ef4444', '#f97316', '#eab308', '#84cc16', '#22c55e', '#14b8a6', '#06b6d4', '#3b82f6', '#8b5cf6', '#d946ef'];
        let currentPlaylist = [];
        let currentTrackIndex = -1;
        let isLocalMode = false;
        let favorites = [];

        // Visualizer variables
        let visualizerActive = false;
        let audioContext = null;
        let analyser = null;
        let dataArray = null;
        let canvas = null;
        let ctx = null;
        let time = 0;
        let waveLayers = [];
        let numLayers = 5;
        let speed = 0.008;

        // --- DOM Elements ---
        const mainContent = document.getElementById('main-content');
        const genreButtonsContainer = document.getElementById('genre-buttons');
        const toggleSearchBtn = document.getElementById('toggleSearchBtn');
        const searchSection = document.getElementById('search-section');
        const searchInput = document.getElementById('searchInput');
        const searchButton = document.getElementById('searchButton');
        const stationListContainer = document.getElementById('station-list');
        const favoritesContainer = document.getElementById('favorites');
        const stationListPanel = document.getElementById('station-list-panel');
        const favoritesPanel = document.getElementById('favorites-panel');
        const tabResults = document.getElementById('tab-results');
        const tabFavorites = document.getElementById('tab-favorites');
        const fileInput = document.getElementById('file-input');
        const folderInput = document.getElementById('folder-input');
        const loadFilesBtn = document.getElementById('load-files-btn');
        const loadFolderBtn = document.getElementById('load-folder-btn');
        const clearPlaylistBtn = document.getElementById('clear-playlist-btn');
        const visualizerBtn = document.getElementById('visualizer-btn');
        const visualizerCanvas = document.getElementById('visualizer-canvas');
        
        // Player Elements
        const audioPlayer = document.getElementById('audioPlayer');
        const fullscreenPlayer = document.getElementById('fullscreen-player');
        const fullscreenStationIcon = document.getElementById('fullscreen-station-icon');
        const fullscreenStationIconContainer = document.getElementById('fullscreen-station-icon-container');
        const fullscreenPlayingName = document.getElementById('fullscreen-playing-name');
        const fullscreenPlayingArtist = document.getElementById('fullscreen-playing-artist');
        const fullscreenPlayingTags = document.getElementById('fullscreen-playing-tags');
        const progressContainer = document.getElementById('progress-container');
        const progressBar = document.getElementById('progress-bar');
        const progressBg = document.getElementById('progress-bg');
        const currentTimeEl = document.getElementById('current-time');
        const totalTimeEl = document.getElementById('total-time');
        const minimizeBtn = document.getElementById('minimize-btn');
        const playPauseBtn = document.getElementById('play-pause-btn');
        const playPauseIcon = document.getElementById('play-pause-icon');
        const volumeSlider = document.getElementById('volume-slider');
        const prevBtn = document.getElementById('prev-btn');
        const nextBtn = document.getElementById('next-btn');
        
        const minimizedPlayer = document.getElementById('minimized-player');
        const minimizedStationIcon = document.getElementById('minimized-station-icon');
        const minimizedStationIconContainer = document.getElementById('minimized-station-icon-container');
        const minimizedPlayingName = document.getElementById('minimized-playing-name');
        const stopBtnMinimized = document.getElementById('stop-btn-minimized');
        

        // --- App Initialization ---
        async function initialize() {
            console.log("Initializing Media Player...");
            
            // UI setup
            favorites = getFavorites();
            console.log(`Loaded ${favorites.length} favorites from browser memory`);
            displayItems(favorites, favoritesContainer, true);
            createGenreButtons();
            toggleSearchBtn.addEventListener('click', () => searchSection.classList.toggle('hidden'));
            searchButton.addEventListener('click', searchStationsManually);
            searchInput.addEventListener('keypress', e => { if (e.key === 'Enter') searchStationsManually(); });
            
            // Local file setup
            loadFilesBtn.addEventListener('click', () => fileInput.click());
            loadFolderBtn.addEventListener('click', () => folderInput.click());
            clearPlaylistBtn.addEventListener('click', clearLocalPlaylist);
            visualizerBtn.addEventListener('click', toggleVisualizer);
            fileInput.addEventListener('change', handleFileSelection);
            folderInput.addEventListener('change', handleFolderSelection);

            // Tab listeners
            tabResults.addEventListener('click', () => showTab('results'));
            tabFavorites.addEventListener('click', () => showTab('favorites'));

            // Player controls
            minimizeBtn.addEventListener('click', (e) => {
                e.preventDefault();
                e.stopPropagation();
                console.log('Minimize button clicked');
                minimizePlayerView();
            });
            minimizeBtn.addEventListener('touchend', (e) => {
                e.preventDefault();
                e.stopPropagation();
                console.log('Minimize button touched');
                minimizePlayerView();
            });
            playPauseBtn.addEventListener('click', togglePlayPause);
            volumeSlider.addEventListener('input', (e) => audioPlayer.volume = e.target.value);
            audioPlayer.addEventListener('play', () => playPauseIcon.className = 'fas fa-pause');
            audioPlayer.addEventListener('pause', () => playPauseIcon.className = 'fas fa-play');
            audioPlayer.addEventListener('ended', playNextTrack);
            audioPlayer.addEventListener('timeupdate', updateProgress);
            audioPlayer.addEventListener('loadedmetadata', updateDuration);
            prevBtn.addEventListener('click', playPrevTrack);
            nextBtn.addEventListener('click', playNextTrack);

            // Progress bar seeking
            progressBg.addEventListener('click', seekToPosition);
            
            // Keyboard shortcuts
            document.addEventListener('keydown', handleKeyboardShortcuts);
            
            // Drag and drop functionality
            setupDragAndDrop();
            
            // Window resize handler
            window.addEventListener('resize', handleWindowResize);

            stopBtnMinimized.addEventListener('click', (e) => {
                e.preventDefault();
                e.stopPropagation();
                stopStation();
            });
            minimizedPlayer.addEventListener('click', (e) => {
                // If the click was on the stop button, let its own handler deal with it
                if (e.target.closest('#stop-btn-minimized')) {
                    return;
                }
                e.preventDefault();
                showFullscreenPlayer();
            });

            audioPlayer.addEventListener('error', (e) => {
                console.error("Audio playback error:", e);
                stopStation();
                showErrorInList("Could not play this station. It might be offline or the stream format is not supported.");
            });

            console.log("Media Player initialized successfully");
        }

        // --- Keyboard Shortcuts ---
        function handleKeyboardShortcuts(event) {
            // Handle visualizer shortcuts first
            if (handleVisualizerKeys(event)) {
                return;
            }
            
            // Only handle other shortcuts when player is visible and not typing in inputs
            if (fullscreenPlayer.classList.contains('hidden') || 
                event.target.tagName === 'INPUT' || 
                event.target.tagName === 'TEXTAREA') {
                return;
            }

            switch(event.code) {
                case 'Space':
                    event.preventDefault();
                    togglePlayPause();
                    break;
                case 'ArrowLeft':
                    event.preventDefault();
                    if (isLocalMode && currentPlaylist.length > 0) {
                        playPrevTrack();
                    } else if (audioPlayer.duration) {
                        audioPlayer.currentTime = Math.max(0, audioPlayer.currentTime - 10);
                    }
                    break;
                case 'ArrowRight':
                    event.preventDefault();
                    if (isLocalMode && currentPlaylist.length > 0) {
                        playNextTrack();
                    } else if (audioPlayer.duration) {
                        audioPlayer.currentTime = Math.min(audioPlayer.duration, audioPlayer.currentTime + 10);
                    }
                    break;
                case 'ArrowUp':
                    event.preventDefault();
                    volumeSlider.value = Math.min(1, parseFloat(volumeSlider.value) + 0.1);
                    audioPlayer.volume = volumeSlider.value;
                    break;
                case 'ArrowDown':
                    event.preventDefault();
                    volumeSlider.value = Math.max(0, parseFloat(volumeSlider.value) - 0.1);
                    audioPlayer.volume = volumeSlider.value;
                    break;
                case 'KeyM':
                    event.preventDefault();
                    audioPlayer.muted = !audioPlayer.muted;
                    break;
                case 'Escape':
                    if (!visualizerActive) {
                        event.preventDefault();
                        minimizePlayerView();
                    }
                    break;
                case 'KeyV':
                    event.preventDefault();
                    toggleVisualizer();
                    break;
            }
        }

        // --- Drag and Drop Setup ---
        function setupDragAndDrop() {
            const dropZone = mainContent;
            
            // Prevent default drag behaviors
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                dropZone.addEventListener(eventName, preventDefaults, false);
                document.body.addEventListener(eventName, preventDefaults, false);
            });

            // Highlight drop zone when item is dragged over it
            ['dragenter', 'dragover'].forEach(eventName => {
                dropZone.addEventListener(eventName, highlight, false);
            });

            ['dragleave', 'drop'].forEach(eventName => {
                dropZone.addEventListener(eventName, unhighlight, false);
            });

            // Handle dropped files
            dropZone.addEventListener('drop', handleDrop, false);

            function preventDefaults(e) {
                e.preventDefault();
                e.stopPropagation();
            }

            function highlight(e) {
                dropZone.style.backgroundColor = 'rgba(99, 102, 241, 0.1)';
                dropZone.style.border = '2px dashed #6366f1';
                dropZone.style.borderRadius = '12px';
            }

            function unhighlight(e) {
                dropZone.style.backgroundColor = '';
                dropZone.style.border = '';
                dropZone.style.borderRadius = '';
            }

            async function handleDrop(e) {
                const dt = e.dataTransfer;
                const files = [...dt.files];
                
                // Filter for audio files
                const audioFiles = files.filter(file => {
                    const validTypes = ['audio/mpeg', 'audio/flac', 'audio/wav', 'audio/ogg', 'audio/m4a', 'audio/aac'];
                    const validExtensions = ['.mp3', '.flac', '.wav', '.ogg', '.m4a', '.aac'];
                    return validTypes.includes(file.type) || validExtensions.some(ext => file.name.toLowerCase().endsWith(ext));
                });
                
                if (audioFiles.length > 0) {
                    await processAudioFiles(audioFiles, 'dropped files');
                } else if (files.length > 0) {
                    // Show message if files were dropped but none were audio files
                    const message = document.createElement('div');
                    message.className = 'fixed top-4 right-4 bg-red-600 text-white px-4 py-2 rounded-lg shadow-lg z-50';
                    message.innerHTML = '<i class="fas fa-exclamation-triangle mr-2"></i>No supported audio files found';
                    document.body.appendChild(message);
                    
                    setTimeout(() => {
                        message.style.opacity = '0';
                        setTimeout(() => message.remove(), 300);
                    }, 3000);
                }
            }
        }

        // --- Audio Visualizer ---
        const visualizerPalettes = [
            { // Ocean Blues
                bg: [10, 20, 50],
                colors: [
                    [60, 120, 180, 100],
                    [40, 100, 160, 120],
                    [30, 80, 140, 140],
                    [20, 60, 120, 160],
                    [15, 40, 100, 180]
                ]
            },
            { // Sunset Hues
                bg: [40, 20, 30],
                colors: [
                    [255, 180, 120, 100],
                    [255, 150, 100, 120],
                    [240, 120, 80, 140],
                    [200, 80, 60, 160],
                    [150, 60, 50, 180]
                ]
            },
            { // Calm Greens
                bg: [20, 40, 30],
                colors: [
                    [120, 200, 150, 100],
                    [100, 180, 130, 120],
                    [80, 160, 110, 140],
                    [60, 140, 90, 160],
                    [40, 120, 70, 180]
                ]
            },
            { // Purple Dreams
                bg: [25, 10, 40],
                colors: [
                    [180, 120, 255, 100],
                    [160, 100, 240, 120],
                    [140, 80, 220, 140],
                    [120, 60, 200, 160],
                    [100, 40, 180, 180]
                ]
            }
        ];
        let currentVisualizerPaletteIndex = 0;
        let activeVisualizerPalette = visualizerPalettes[0];

        function toggleVisualizer() {
            visualizerActive = !visualizerActive;
            
            if (visualizerActive) {
                initializeVisualizer();
                visualizerCanvas.classList.remove('hidden');
                visualizerBtn.innerHTML = '<i class="fas fa-eye-slash"></i>Hide Visualizer';
                visualizerBtn.classList.remove('from-purple-600', 'to-pink-600', 'hover:from-purple-700', 'hover:to-pink-700');
                visualizerBtn.classList.add('from-green-600', 'to-blue-600', 'hover:from-green-700', 'hover:to-blue-700');
                startVisualizerAnimation();
            } else {
                visualizerCanvas.classList.add('hidden');
                visualizerBtn.innerHTML = '<i class="fas fa-wave-square"></i>Visualizer';
                visualizerBtn.classList.remove('from-green-600', 'to-blue-600', 'hover:from-green-700', 'hover:to-blue-700');
                visualizerBtn.classList.add('from-purple-600', 'to-pink-600', 'hover:from-purple-700', 'hover:to-pink-700');
            }
        }

        function initializeVisualizer() {
            canvas = visualizerCanvas;
            ctx = canvas.getContext('2d');
            
            // Set canvas size with device pixel ratio for crisp rendering
            const dpr = window.devicePixelRatio || 1;
            canvas.width = window.innerWidth * dpr;
            canvas.height = window.innerHeight * dpr;
            canvas.style.width = window.innerWidth + 'px';
            canvas.style.height = window.innerHeight + 'px';
            ctx.scale(dpr, dpr);
            
            // Initialize audio analysis if playing
            if (!audioPlayer.paused && !audioContext) {
                try {
                    audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    analyser = audioContext.createAnalyser();
                    analyser.fftSize = 512; // Increased for better frequency resolution
                    analyser.smoothingTimeConstant = 0.8; // Smooth out the audio data
                    dataArray = new Uint8Array(analyser.frequencyBinCount);
                    
                    const source = audioContext.createMediaElementSource(audioPlayer);
                    source.connect(analyser);
                    analyser.connect(audioContext.destination);
                } catch (error) {
                    console.warn('Audio analysis not available:', error);
                }
            }
            
            // Initialize wave layers with improved parameters
            waveLayers = [];
            for (let i = 0; i < numLayers; i++) {
                waveLayers.push({
                    yOffsetNoise: i * 150 + Math.random() * 50,
                    amplitude: 60 + Math.random() * 80,
                    xNoiseScale: 0.001 + Math.random() * 0.002,
                    color: activeVisualizerPalette.colors[i % activeVisualizerPalette.colors.length],
                    baseY: window.innerHeight * (0.3 + i * 0.12),
                    audioSensitivity: 0.5 + Math.random() * 0.8,
                    phase: Math.random() * Math.PI * 2,
                    frequency: 0.5 + Math.random() * 0.5
                });
            }
        }

        function startVisualizerAnimation() {
            if (!visualizerActive) return;
            
            drawVisualizer();
            requestAnimationFrame(startVisualizerAnimation);
        }

        function drawVisualizer() {
            if (!canvas || !ctx) return;
            
            time += speed;
            
            // Get audio data if available
            let audioLevel = 0;
            let frequencyData = null;
            if (analyser && dataArray) {
                analyser.getByteFrequencyData(dataArray);
                // Calculate average audio level
                let sum = 0;
                for (let i = 0; i < dataArray.length; i++) {
                    sum += dataArray[i];
                }
                audioLevel = sum / dataArray.length / 255; // Normalize to 0-1
                frequencyData = dataArray;
            }
            
            // Clear canvas with background
            const bg = activeVisualizerPalette.bg;
            ctx.fillStyle = `rgb(${bg[0]}, ${bg[1]}, ${bg[2]})`;
            ctx.fillRect(0, 0, window.innerWidth, window.innerHeight);
            
            // Draw wave layers
            for (let i = 0; i < waveLayers.length; i++) {
                const layer = waveLayers[i];
                const color = layer.color;
                
                // Create gradient for more depth
                const gradient = ctx.createLinearGradient(0, layer.baseY - layer.amplitude, 0, window.innerHeight);
                gradient.addColorStop(0, `rgba(${color[0]}, ${color[1]}, ${color[2]}, ${color[3] / 255})`);
                gradient.addColorStop(1, `rgba(${color[0]}, ${color[1]}, ${color[2]}, ${color[3] / 400})`);
                ctx.fillStyle = gradient;
                
                ctx.beginShape();
                const points = [];
                
                // Generate smooth wave points
                for (let x = 0; x <= window.innerWidth; x += 8) {
                    // Smooth noise with multiple octaves
                    const noiseValue = smoothNoise(x * layer.xNoiseScale, layer.yOffsetNoise + time * 0.3, time * 0.1);
                    
                    // Add subtle audio reactivity
                    let audioInfluence = 0;
                    if (frequencyData && audioLevel > 0.005) {
                        const bandSize = Math.floor(frequencyData.length / numLayers);
                        const startIdx = i * bandSize;
                        const endIdx = Math.min(startIdx + bandSize, frequencyData.length);
                        
                        let bandAverage = 0;
                        for (let j = startIdx; j < endIdx; j++) {
                            bandAverage += frequencyData[j];
                        }
                        bandAverage /= (endIdx - startIdx);
                        
                        const freqValue = bandAverage / 255;
                        audioInfluence = freqValue * layer.audioSensitivity * audioLevel * 60; // Reduced for smoothness
                        
                        // Add gentle phase-based movement
                        audioInfluence += Math.sin(time * layer.frequency + layer.phase + x * 0.001) * audioLevel * 20;
                    }
                    
                    const amplitude = layer.amplitude + audioInfluence;
                    const y = layer.baseY + Math.sin(noiseValue * Math.PI * 2) * amplitude * 0.5; // Smoother wave shape
                    
                    points.push({ x, y });
                }
                
                // Draw smooth curve using bezier curves
                ctx.beginPath();
                ctx.moveTo(0, window.innerHeight);
                ctx.lineTo(points[0].x, points[0].y);
                
                for (let i = 1; i < points.length - 1; i++) {
                    const current = points[i];
                    const next = points[i + 1];
                    const cpx = (current.x + next.x) / 2;
                    const cpy = (current.y + next.y) / 2;
                    ctx.quadraticCurveTo(current.x, current.y, cpx, cpy);
                }
                
                // Complete the shape
                const lastPoint = points[points.length - 1];
                ctx.lineTo(lastPoint.x, lastPoint.y);
                ctx.lineTo(window.innerWidth, window.innerHeight);
                ctx.closePath();
                ctx.fill();
            }
            
            // Draw instructions with better styling
            ctx.shadowColor = 'rgba(0, 0, 0, 0.5)';
            ctx.shadowBlur = 4;
            ctx.shadowOffsetY = 2;
            
            if (!audioPlayer.paused && audioLevel > 0.005) {
                ctx.fillStyle = 'rgba(255, 255, 255, 0.4)';
                ctx.font = '16px -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif';
                ctx.textAlign = 'center';
                ctx.fillText('Press [C] to change colors • [ESC] to hide visualizer', window.innerWidth / 2, window.innerHeight - 30);
            } else {
                ctx.fillStyle = 'rgba(255, 255, 255, 0.8)';
                ctx.font = 'bold 24px -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif';
                ctx.textAlign = 'center';
                ctx.fillText('Play music to see audio-reactive visualization', window.innerWidth / 2, window.innerHeight / 2);
                ctx.font = '16px -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif';
                ctx.fillText('Press [C] to change colors • [ESC] to hide visualizer', window.innerWidth / 2, window.innerHeight / 2 + 40);
            }
            
            // Reset shadow
            ctx.shadowColor = 'transparent';
            ctx.shadowBlur = 0;
            ctx.shadowOffsetY = 0;
        }

        // Smoother noise function
        function smoothNoise(x, y, z) {
            // Single octave for smoother waves
            const baseNoise = Math.sin(x * 2 + y * 0.1 + z) * 0.5 + 
                             Math.cos(x * 1.5 + y * 0.05 + z * 0.7) * 0.3 +
                             Math.sin(x * 0.8 + y * 0.02 + z * 1.2) * 0.2;
            return (baseNoise + 1) / 2; // Normalize to 0-1
        }

        // Handle visualizer keyboard shortcuts
        function handleVisualizerKeys(event) {
            if (!visualizerActive) return false;
            
            if (event.key.toLowerCase() === 'c') {
                currentVisualizerPaletteIndex = (currentVisualizerPaletteIndex + 1) % visualizerPalettes.length;
                activeVisualizerPalette = visualizerPalettes[currentVisualizerPaletteIndex];
                // Update layer colors
                for (let i = 0; i < waveLayers.length; i++) {
                    waveLayers[i].color = activeVisualizerPalette.colors[i % activeVisualizerPalette.colors.length];
                }
                return true;
            }
            
            if (event.key === 'Escape') {
                toggleVisualizer();
                return true;
            }
            
            return false;
        }

        function handleWindowResize() {
            if (visualizerActive && canvas) {
                const dpr = window.devicePixelRatio || 1;
                canvas.width = window.innerWidth * dpr;
                canvas.height = window.innerHeight * dpr;
                canvas.style.width = window.innerWidth + 'px';
                canvas.style.height = window.innerHeight + 'px';
                ctx.scale(dpr, dpr);
                
                // Recalculate wave layer positions
                for (let i = 0; i < waveLayers.length; i++) {
                    waveLayers[i].baseY = window.innerHeight * (0.3 + i * 0.12);
                }
            }
        }

        function createGenreButtons() {
            GENRES.forEach(genre => {
                const btn = document.createElement('button');
                btn.className = 'genre-btn bg-slate-700 text-slate-300 px-4 py-2 rounded-full font-semibold border border-slate-600 hover:bg-slate-600 hover:text-white';
                btn.textContent = genre;
                btn.dataset.genre = genre;
                btn.addEventListener('click', () => searchByGenre(genre));
                genreButtonsContainer.appendChild(btn);
            });
        }

        // --- Helper Functions ---
        const getRandomColor = () => PLACEHOLDER_COLORS[Math.floor(Math.random() * PLACEHOLDER_COLORS.length)];
        const isChristmasSeason = () => new Date().getMonth() === 10 || new Date().getMonth() === 11;
        const showErrorInList = (message) => {
            stationListContainer.innerHTML = `<p class="text-center p-4 text-red-400">${message}</p>`;
            showTab('results');
        };

        function showTab(tabName) {
            if (tabName === 'results') {
                stationListPanel.classList.remove('hidden');
                favoritesPanel.classList.add('hidden');
                tabResults.classList.add('active');
                tabFavorites.classList.remove('active');
            } else {
                stationListPanel.classList.add('hidden');
                favoritesPanel.classList.remove('hidden');
                tabResults.classList.remove('active');
                tabFavorites.classList.add('active');
            }
        }

        // --- Radio Station Functions ---
        async function searchByGenre(genre) {
            stationListContainer.innerHTML = '<p class="text-center p-4 text-slate-400">Searching...</p>';
            showTab('results');
            const tagList = genre.toLowerCase().replace(/\s+/g, ',');
            try {
                const response = await fetch(`${RADIO_API_BASE}/stations/search?tagList=${encodeURIComponent(tagList)}&limit=150&hidebroken=true`);
                handleApiResponse(response);
            } catch (error) {
                handleApiError(error);
            }
        }

        async function searchStationsManually() {
            const query = searchInput.value.trim();
            if (!query) return;
            stationListContainer.innerHTML = '<p class="text-center p-4 text-slate-400">Searching...</p>';
            showTab('results');
            try {
                const response = await fetch(`${RADIO_API_BASE}/stations/byname/${encodeURIComponent(query)}?limit=150&hidebroken=true`);
                handleApiResponse(response);
            } catch (error) {
                handleApiError(error);
            }
        }

        async function handleApiResponse(response) {
            if (!response.ok) throw new Error(`API request failed with status ${response.status}`);
            let stations = await response.json();
            
            const arabicCharRegex = /[\u0600-\u06FF]/;

            // Filter out unwanted stations
            stations = stations.filter(station => {
                const stationName = station.name.toLowerCase();
                
                if (!isChristmasSeason() && stationName.includes('christmas')) return false;
                if (stationName.includes('quran')) return false;
                if (station.countrycode === 'SA') return false;
                if (arabicCharRegex.test(station.name)) return false;
                
                return station.bitrate > 0;
            });
            isLocalMode = false;
            currentPlaylist = stations;
            displayItems(stations, stationListContainer, false);
        }

        function handleApiError(error) {
            console.error(`Error fetching stations:`, error);
            showErrorInList("Error fetching stations. Please try again later.");
        }

        function displayItems(items, container, isFavoriteList) {
            container.innerHTML = '';
            if (items.length === 0) {
                container.innerHTML = `<p class="px-4 py-8 text-center text-slate-400">${isFavoriteList ? 'No favorite stations saved.' : 'No items found.'}</p>`;
                return;
            }

            const highBitrateItems = isLocalMode ? items : items.filter(s => s.bitrate >= 128);
            const lowBitrateItems = isLocalMode ? [] : items.filter(s => s.bitrate < 128);

            const renderGroup = (itemList, title) => {
                if (itemList.length === 0) return;

                if (title) {
                    const groupHeader = document.createElement('h3');
                    groupHeader.className = 'px-4 pt-4 pb-2 text-lg font-semibold text-slate-300 tracking-wider';
                    groupHeader.textContent = title;
                    container.appendChild(groupHeader);
                }
                
                itemList.forEach((item, index) => {
                    const stationEl = document.createElement('div');
                    stationEl.className = 'station-item p-3 rounded-lg flex items-center justify-between gap-4';
                    
                    const isFile = item.file || item instanceof File;
                    const iconSrc = isFile ? null : item.favicon;
                    
                    let name, details;
                    if (isFile) {
                        name = item.title || item.name;
                        const duration = item.duration ? formatDuration(item.duration) : '';
                        const fileSize = item.size ? formatFileSize(item.size) : '';
                        const artist = item.artist || '';
                        
                        if (artist && duration) {
                            details = `${artist} &bull; ${duration}`;
                        } else if (artist) {
                            details = artist;
                        } else if (duration) {
                            details = `${duration}${fileSize ? ' &bull; ' + fileSize : ''}`;
                        } else {
                            details = fileSize || 'Local Audio File';
                        }
                    } else {
                        name = item.name;
                        details = `${item.country || 'Unknown'} &bull; ${item.bitrate} kbps`;
                    }

                    stationEl.innerHTML = `
                        <div class="flex items-center gap-4 truncate">
                            <div class="icon-container w-12 h-12 rounded-full flex-shrink-0 bg-slate-700 flex items-center justify-center">
                                <img src="${iconSrc || ''}" class="w-full h-full rounded-full object-cover">
                            </div>
                            <div class="truncate">
                                <h3 class="font-semibold text-md text-slate-200 truncate">${name}</h3>
                                <p class="text-sm text-slate-400">${details}</p>
                            </div>
                        </div>
                        <div class="buttons-container flex items-center gap-2 flex-shrink-0"></div>
                    `;
                    
                    const img = stationEl.querySelector('img');
                    img.onerror = function() {
                        const parent = this.parentElement;
                        if (isFile) {
                            parent.innerHTML = '<i class="fas fa-music text-white/80"></i>';
                        } else {
                            parent.innerHTML = '<i class="fas fa-radio text-white/80"></i>';
                        }
                        parent.style.backgroundColor = getRandomColor();
                    };
                    if (isFile) { img.onerror(); }

                    const buttonsDiv = stationEl.querySelector('.buttons-container');
                    const playBtn = document.createElement('button');
                    playBtn.className = 'action-btn bg-indigo-600 text-white w-10 h-10 rounded-full font-semibold hover:bg-indigo-700 flex items-center justify-center';
                    playBtn.innerHTML = '<i class="fas fa-play"></i>';
                    playBtn.onclick = () => playItem(item, isFavoriteList ? -1 : itemList.indexOf(item));
                    buttonsDiv.appendChild(playBtn);

                    if (isFavoriteList) {
                        const removeBtn = document.createElement('button');
                        removeBtn.className = 'action-btn bg-slate-700 text-slate-300 w-10 h-10 rounded-full font-semibold hover:bg-slate-600 flex items-center justify-center';
                        removeBtn.innerHTML = '<i class="fas fa-trash"></i>';
                        removeBtn.onclick = () => removeFavorite(item.stationuuid);
                        buttonsDiv.appendChild(removeBtn);
                    } else if (!isFile) {
                        const isFavorited = favorites.some(fav => fav.stationuuid === item.stationuuid);
                        const favBtn = document.createElement('button');
                        favBtn.className = 'action-btn w-10 h-10 rounded-full font-semibold flex items-center justify-center';

                        if (isFavorited) {
                            favBtn.innerHTML = '<i class="fas fa-heart"></i>';
                            favBtn.classList.add('bg-pink-500/20', 'text-pink-400');
                            favBtn.disabled = true;
                        } else {
                            favBtn.innerHTML = '<i class="far fa-heart"></i>';
                            favBtn.classList.add('bg-slate-700', 'text-slate-300', 'hover:bg-slate-600');
                            favBtn.onclick = (event) => addFavorite(item, event.currentTarget);
                        }

                        buttonsDiv.appendChild(favBtn);
                    }
                    container.appendChild(stationEl);
                });
            };
            
            if (isLocalMode) {
                renderGroup(highBitrateItems, null);
            } else {
                renderGroup(highBitrateItems, 'High Quality');
                renderGroup(lowBitrateItems, 'Standard Quality');
            }
        }

        // --- Local File Handling with Metadata ---
        async function handleFileSelection(event) {
            const files = Array.from(event.target.files);
            if (files.length === 0) return;
            
            await processAudioFiles(files, 'files');
        }

        async function handleFolderSelection(event) {
            const files = Array.from(event.target.files);
            if (files.length === 0) return;
            
            // Filter for audio files only
            const audioFiles = files.filter(file => {
                const validTypes = ['audio/mpeg', 'audio/flac', 'audio/wav', 'audio/ogg', 'audio/m4a', 'audio/aac'];
                const validExtensions = ['.mp3', '.flac', '.wav', '.ogg', '.m4a', '.aac'];
                return validTypes.includes(file.type) || validExtensions.some(ext => file.name.toLowerCase().endsWith(ext));
            });
            
            if (audioFiles.length === 0) {
                alert('No audio files found in the selected folder.');
                return;
            }
            
            await processAudioFiles(audioFiles, 'folder');
        }

        async function processAudioFiles(files, source) {
            console.log(`Loading ${files.length} audio ${source}...`);
            
            // Show loading screen with progress bar
            const sourceText = source === 'folder' ? 'folder contents' : 'selected files';
            showLoadingScreen(files.length, sourceText);
            showTab('results');
            
            isLocalMode = true;
            
            // If we already have files, ask user if they want to append or replace
            if (currentPlaylist.length > 0) {
                const shouldAppend = confirm(`You already have ${currentPlaylist.length} files loaded. Would you like to add these files to your current playlist?\n\nClick OK to add files, Cancel to replace the current playlist.`);
                if (!shouldAppend) {
                    currentPlaylist = [];
                }
            }
            
            const startingLength = currentPlaylist.length;
            let processedCount = 0;
            
            // Process files in batches for better performance
            const batchSize = 10;
            for (let i = 0; i < files.length; i += batchSize) {
                const batch = files.slice(i, i + batchSize);
                
                // Process batch
                const batchPromises = batch.map(async (file) => {
                    try {
                        const audioFile = await processAudioFile(file);
                        processedCount++;
                        updateLoadingProgress(processedCount, files.length);
                        return audioFile;
                    } catch (error) {
                        console.error(`Error processing ${file.name}:`, error);
                        processedCount++;
                        updateLoadingProgress(processedCount, files.length);
                        return createFallbackAudioFile(file);
                    }
                });
                
                const batchResults = await Promise.all(batchPromises);
                currentPlaylist.push(...batchResults);
                
                // Small delay to prevent UI blocking
                await new Promise(resolve => setTimeout(resolve, 10));
            }
            
            hideLoadingScreen();
            
            // Sort by title or filename
            currentPlaylist.sort((a, b) => {
                const aName = a.title || a.name;
                const bName = b.title || b.name;
                return aName.localeCompare(bName);
            });
            
            displayItems(currentPlaylist, stationListContainer, false);
            
            // Show clear button when we have local files
            clearPlaylistBtn.classList.remove('hidden');
            
            const newFilesCount = currentPlaylist.length - startingLength;
            console.log(`Successfully loaded ${newFilesCount} new audio files (${currentPlaylist.length} total)`);
            
            // Show success message
            showSuccessMessage(newFilesCount);
        }

        function showLoadingScreen(totalFiles, sourceText) {
            stationListContainer.innerHTML = `
                <div class="text-center p-8">
                    <div class="mb-6">
                        <div class="w-16 h-16 border-4 border-indigo-500 border-t-transparent rounded-full animate-spin mx-auto mb-4"></div>
                        <h3 class="text-xl font-semibold text-slate-200 mb-2">Processing Audio Files</h3>
                        <p class="text-slate-400">Loading ${totalFiles} files from ${sourceText}...</p>
                    </div>
                    
                    <div class="w-full max-w-md mx-auto">
                        <div class="flex justify-between text-sm text-slate-400 mb-2">
                            <span id="progress-current">0</span>
                            <span>of ${totalFiles} files</span>
                        </div>
                        <div class="w-full bg-slate-700 rounded-full h-3">
                            <div id="progress-fill" class="bg-gradient-to-r from-indigo-500 to-purple-500 h-3 rounded-full transition-all duration-300" style="width: 0%"></div>
                        </div>
                        <div class="mt-2">
                            <span id="progress-percentage" class="text-sm font-medium text-indigo-400">0%</span>
                        </div>
                    </div>
                    
                    <p class="text-xs text-slate-500 mt-4">Large collections may take a moment to process</p>
                </div>
            `;
        }

        function updateLoadingProgress(current, total) {
            const percentage = Math.round((current / total) * 100);
            const currentEl = document.getElementById('progress-current');
            const fillEl = document.getElementById('progress-fill');
            const percentageEl = document.getElementById('progress-percentage');
            
            if (currentEl) currentEl.textContent = current;
            if (fillEl) fillEl.style.width = `${percentage}%`;
            if (percentageEl) percentageEl.textContent = `${percentage}%`;
        }

        function hideLoadingScreen() {
            // Loading screen will be replaced by displayItems
        }

        function showSuccessMessage(count) {
            setTimeout(() => {
                const successMessage = document.createElement('div');
                successMessage.className = 'fixed top-4 right-4 bg-green-600 text-white px-6 py-3 rounded-lg shadow-lg z-50 transition-all duration-300 transform translate-x-full';
                successMessage.innerHTML = `
                    <div class="flex items-center gap-3">
                        <i class="fas fa-check-circle text-xl"></i>
                        <div>
                            <p class="font-semibold">Files Added Successfully</p>
                            <p class="text-sm opacity-90">${count} files added to playlist</p>
                        </div>
                    </div>
                `;
                document.body.appendChild(successMessage);
                
                // Animate in
                setTimeout(() => {
                    successMessage.style.transform = 'translateX(0)';
                }, 100);
                
                // Animate out
                setTimeout(() => {
                    successMessage.style.transform = 'translateX(full)';
                    setTimeout(() => successMessage.remove(), 300);
                }, 3000);
            }, 500);
        }

        function clearLocalPlaylist() {
            if (currentPlaylist.length === 0) return;
            
            if (confirm(`Are you sure you want to clear all ${currentPlaylist.length} files from your playlist?`)) {
                // Stop current playback if it's a local file
                if (isLocalMode && !audioPlayer.paused) {
                    stopStation();
                }
                
                // Clean up object URLs to prevent memory leaks
                currentPlaylist.forEach(item => {
                    if (item.url && item.url.startsWith('blob:')) {
                        URL.revokeObjectURL(item.url);
                    }
                });
                
                currentPlaylist = [];
                isLocalMode = false;
                currentTrackIndex = -1;
                
                stationListContainer.innerHTML = `
                    <div class="px-4 py-12 text-center text-slate-400">
                        <div class="mb-4">
                            <i class="fas fa-music text-4xl text-slate-600 mb-4"></i>
                        </div>
                        <p class="text-lg mb-2">No audio files loaded</p>
                        <p class="text-sm text-slate-500 mb-4">Select a genre for radio stations, or add your music:</p>
                        <div class="space-y-2 text-sm">
                            <p><i class="fas fa-file-audio text-indigo-400 mr-2"></i>Click "Add Files" to select individual tracks</p>
                            <p><i class="fas fa-folder-open text-purple-400 mr-2"></i>Click "Add Folder" to load an entire album/folder</p>
                            <p><i class="fas fa-hand-pointer text-blue-400 mr-2"></i>Or simply drag and drop files here</p>
                        </div>
                    </div>
                `;
                clearPlaylistBtn.classList.add('hidden');
                
                console.log('Playlist cleared');
            }
        }

        async function processAudioFile(file) {
            return new Promise((resolve) => {
                const audio = new Audio();
                const url = URL.createObjectURL(file);
                
                const audioFile = {
                    file: file,
                    name: file.name,
                    title: extractTitleFromFilename(file.name),
                    artist: '',
                    album: '',
                    duration: 0,
                    url: url,
                    size: file.size,
                    type: file.type,
                    lastModified: file.lastModified
                };

                audio.addEventListener('loadedmetadata', () => {
                    audioFile.duration = audio.duration;
                    resolve(audioFile);
                });

                audio.addEventListener('error', () => {
                    resolve(audioFile);
                });

                audio.src = url;
            });
        }

        function createFallbackAudioFile(file) {
            return {
                file: file,
                name: file.name,
                title: extractTitleFromFilename(file.name),
                artist: '',
                album: '',
                duration: 0,
                url: URL.createObjectURL(file),
                size: file.size,
                type: file.type,
                lastModified: file.lastModified
            };
        }

        function extractTitleFromFilename(filename) {
            // Remove file extension
            let title = filename.replace(/\.[^/.]+$/, "");
            
            // Remove common patterns like track numbers
            title = title.replace(/^\d+[\s\-\.]*/, "");
            title = title.replace(/^\d+\s*-\s*/, "");
            
            // Replace underscores and multiple spaces with single spaces
            title = title.replace(/_/g, ' ').replace(/\s+/g, ' ').trim();
            
            return title || filename;
        }

        function formatDuration(seconds) {
            if (!seconds || seconds === 0) return '';
            const mins = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            return `${mins}:${secs.toString().padStart(2, '0')}`;
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
        }

        // --- Player View Functions ---
        async function playItem(item, index) {
            audioPlayer.pause();
            audioPlayer.src = '';
            currentTrackIndex = index;

            const isFile = item.file || item instanceof File;
            let streamUrl;
            
            if (isFile) {
                streamUrl = item.url || URL.createObjectURL(item.file || item);
            } else {
                streamUrl = item.url_resolved || item.url;
            }
            
            if (!streamUrl) {
                showErrorInList("This item does not have a valid stream URL.");
                return;
            }
            
            audioPlayer.src = streamUrl;
            
            try {
                await audioPlayer.play();
                
                // Update display based on file type
                if (isFile) {
                    fullscreenPlayingName.textContent = item.title || item.name;
                    fullscreenPlayingArtist.textContent = item.artist || '';
                    fullscreenPlayingTags.textContent = item.album || '';
                    minimizedPlayingName.textContent = `${item.title || item.name}${item.artist ? ' - ' + item.artist : ''}`;
                    
                    // Show progress container for local files
                    progressContainer.classList.remove('hidden');
                    
                    // Always show prev/next for local files
                    prevBtn.style.display = 'flex';
                    nextBtn.style.display = 'flex';
                } else {
                    fullscreenPlayingName.textContent = item.name;
                    fullscreenPlayingArtist.textContent = '';
                    fullscreenPlayingTags.textContent = item.tags || 'Radio Station';
                    minimizedPlayingName.textContent = item.name;
                    
                    // Hide progress container for radio streams
                    progressContainer.classList.add('hidden');
                    
                    // Hide prev/next for radio unless in local mode
                    const playlistControlsVisibility = isLocalMode ? 'flex' : 'none';
                    prevBtn.style.display = playlistControlsVisibility;
                    nextBtn.style.display = playlistControlsVisibility;
                }

                // Handle icons
                const iconSrc = isFile ? null : item.favicon;
                fullscreenStationIcon.src = iconSrc || '';
                minimizedStationIcon.src = iconSrc || '';

                const setupIcon = (iconEl, containerEl) => {
                    if (isFile || !iconSrc) {
                        containerEl.innerHTML = '<i class="fas fa-music text-5xl text-white/80"></i>';
                        containerEl.style.backgroundColor = getRandomColor();
                    } else {
                        containerEl.innerHTML = '';
                        containerEl.appendChild(iconEl);
                        iconEl.onerror = function() {
                            containerEl.innerHTML = '<i class="fas fa-music text-5xl text-white/80"></i>';
                            containerEl.style.backgroundColor = getRandomColor();
                        };
                    }
                };
                setupIcon(fullscreenStationIcon, fullscreenStationIconContainer);
                setupIcon(minimizedStationIcon, minimizedStationIconContainer);

                showFullscreenPlayer();
            } catch (error) {
                if (error.name !== 'AbortError') {
                    console.error("Play() promise rejected:", error);
                }
            }
        }

        // --- Progress and Seeking Functions ---
        function updateProgress() {
            if (!audioPlayer.duration) return;
            
            const currentTime = audioPlayer.currentTime;
            const duration = audioPlayer.duration;
            const progressPercent = (currentTime / duration) * 100;
            
            progressBar.style.width = `${progressPercent}%`;
            currentTimeEl.textContent = formatTime(currentTime);
        }

        function updateDuration() {
            if (!audioPlayer.duration) return;
            totalTimeEl.textContent = formatTime(audioPlayer.duration);
        }

        function seekToPosition(event) {
            if (!audioPlayer.duration) return;
            
            const rect = progressBg.getBoundingClientRect();
            const clickX = event.clientX - rect.left;
            const percentage = clickX / rect.width;
            const newTime = percentage * audioPlayer.duration;
            
            audioPlayer.currentTime = newTime;
        }

        function formatTime(seconds) {
            if (!seconds || isNaN(seconds)) return '0:00';
            const mins = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            return `${mins}:${secs.toString().padStart(2, '0')}`;
        }

        function playNextTrack() {
            if (!isLocalMode || currentPlaylist.length === 0) return;
            if (currentTrackIndex < 0) currentTrackIndex = 0;
            currentTrackIndex = (currentTrackIndex + 1) % currentPlaylist.length;
            playItem(currentPlaylist[currentTrackIndex], currentTrackIndex);
        }

        function playPrevTrack() {
            if (!isLocalMode || currentPlaylist.length === 0) return;
            if (currentTrackIndex < 0) currentTrackIndex = 0;
            currentTrackIndex = (currentTrackIndex - 1 + currentPlaylist.length) % currentPlaylist.length;
            playItem(currentPlaylist[currentTrackIndex], currentTrackIndex);
        }

        function togglePlayPause() {
            if (audioPlayer.paused) {
                audioPlayer.play();
            } else {
                audioPlayer.pause();
            }
        }

        function stopStation() {
            audioPlayer.pause();
            
            // Clean up object URLs to prevent memory leaks
            if (audioPlayer.src && audioPlayer.src.startsWith('blob:')) {
                URL.revokeObjectURL(audioPlayer.src);
            }
            
            audioPlayer.src = '';
            fullscreenPlayer.classList.add('hidden');
            minimizedPlayer.classList.add('hidden');
            mainContent.classList.remove('hidden');
            progressContainer.classList.add('hidden');
        }

        function showFullscreenPlayer() {
            fullscreenPlayer.classList.remove('hidden');
            minimizedPlayer.classList.add('hidden');
            mainContent.classList.add('hidden');
        }

        function minimizePlayerView() {
            console.log('Minimizing player view');
            fullscreenPlayer.classList.add('hidden');
            mainContent.classList.remove('hidden');
            // Show minimized player immediately when minimizing
            minimizedPlayer.classList.remove('hidden');
        }


        // --- Favorite Functions (localStorage only - browser memory) ---
        function getFavorites() {
            try {
                const favoritesString = localStorage.getItem('media-player-favorites');
                if (!favoritesString) return [];
                
                const parsed = JSON.parse(favoritesString);
                // Ensure the parsed data is an array
                return Array.isArray(parsed) ? parsed : [];
            } catch (e) {
                console.error("Error parsing favorites from localStorage:", e);
                // If parsing fails, clear corrupted data
                localStorage.removeItem('media-player-favorites');
                return [];
            }
        }

        function saveFavorites() {
            try {
                // Ensure favorites is an array before saving
                if (!Array.isArray(favorites)) {
                    favorites = [];
                }
                localStorage.setItem('media-player-favorites', JSON.stringify(favorites));
                console.log(`Saved ${favorites.length} favorites to browser memory`);
            } catch (e) {
                console.error("Error saving favorites to localStorage:", e);
                // If storage is full or unavailable, show user feedback
                alert("Unable to save favorites - browser storage may be full or disabled.");
            }
        }

        function addFavorite(stationData, buttonElement) {
            // Check if already favorited
            if (favorites.some(fav => fav.stationuuid === stationData.stationuuid)) {
                return;
            }

            // Create a clean object for storage (only essential data)
            const favoriteData = {
                stationuuid: stationData.stationuuid,
                name: stationData.name,
                favicon: stationData.favicon,
                url: stationData.url,
                url_resolved: stationData.url_resolved,
                tags: stationData.tags,
                country: stationData.country,
                countrycode: stationData.countrycode,
                bitrate: stationData.bitrate,
                dateAdded: new Date().toISOString()
            };

            favorites.push(favoriteData);
            saveFavorites();

            // Update button appearance
            buttonElement.innerHTML = '<i class="fas fa-heart"></i>';
            buttonElement.classList.remove('bg-slate-700', 'text-slate-300', 'hover:bg-slate-600');
            buttonElement.classList.add('bg-pink-500/20', 'text-pink-400');
            buttonElement.disabled = true;
            buttonElement.onclick = null;

            // Always refresh favorites panel to show new favorite immediately
            displayItems(favorites, favoritesContainer, true);
        }

        function removeFavorite(stationId) {
            const originalLength = favorites.length;
            favorites = favorites.filter(fav => fav.stationuuid !== stationId);
            
            if (favorites.length < originalLength) {
                saveFavorites();
                displayItems(favorites, favoritesContainer, true);
                console.log(`Removed favorite station with ID: ${stationId}`);
            }
        }

        // Clear all favorites function (for testing/debugging)
        function clearAllFavorites() {
            favorites = [];
            localStorage.removeItem('media-player-favorites');
            displayItems(favorites, favoritesContainer, true);
            console.log("All favorites cleared from browser memory");
        }


        // --- Start the App ---
        initialize();

    </script>
</body>
</html>
